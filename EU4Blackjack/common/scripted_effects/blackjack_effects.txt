# Assigns players 2-4 out of players if possible
assign_blackjack_players = {
    # clear event targets for players from previous game
    # TODO move this to the code for ending the game
    clear_global_event_target = blackjack_player_2_tag
    clear_global_event_target = blackjack_player_3_tag
    clear_global_event_target = blackjack_player_4_tag

    # send an event to every player country to join blackjack
    # first 3 to accept become players 2-4, others even if they accept are rejected
    every_country = {
        limit = {
            AND = {
                NOT = { ai = yes }
                NOT = { has_saved_global_event_target = blackjack_player_1_tag }
            }
        }
        country_event = {
            id = blackjack.1
        }
    }
}

# Assigns empty player slots to AIs
assign_blackjack_ais = {
    if = {
        limit = { NOT = { has_saved_global_event_target = blackjack_player_2_tag } }
        random_country = {
            limit = {
                ai = yes
            }
            save_global_event_target_as = blackjack_player_2_tag
        }
    }
    if = {
        limit = { NOT = { has_saved_global_event_target = blackjack_player_3_tag } }
        random_country = {
            limit = {
                ai = yes
            }
            save_global_event_target_as = blackjack_player_3_tag
        }
    }
    if = {
        limit = { NOT = { has_saved_global_event_target = blackjack_player_4_tag } }
        random_country = {
            limit = {
                ai = yes
            }
            save_global_event_target_as = blackjack_player_4_tag
        }
    }
    
    blackjack_setup_game_flags = yes
}

# setup game flags
blackjack_setup_game_flags = {
    # All game flags are global
    # All game variables are in the blackjack_player_1_tag event target scope

    # Setup Deck
    # The shoe contains 4 decks. It is shuffled when the deck is at least half complete
    blackjack_initialize_deck = yes

    # Assign current card position
    event_target:blackjack_player_1_tag = {
        set_variable = {
            which = blackjack_current_deck_position
            value = 0
        }
    }

    blackjack_shuffle_deck_wrapper = yes

    # Check blackjack_setup_game_flags_two for the continuation of this effect
}

blackjack_setup_game_flags_two = {
    # This exists because of control flow shenanigans
    event_target:blackjack_player_1_tag = {
        country_event = {
            id = blackjack.5
        }
    }
    # It's called from blackjack_shuffle_deck

    # Setup player hands, max size is 18

    # Setup dealer hand, max size is less than 18 but kept at 18 for convinience
}

blackjack_initialize_deck = {
    event_target:blackjack_player_1_tag = {
        set_variable = {
			which = blackjack_deck_0
			value = 1
		}

		set_variable = {
			which = blackjack_deck_1
			value = 1
		}

		set_variable = {
			which = blackjack_deck_2
			value = 1
		}

		set_variable = {
			which = blackjack_deck_3
			value = 1
		}

		set_variable = {
			which = blackjack_deck_4
			value = 2
		}

		set_variable = {
			which = blackjack_deck_5
			value = 2
		}

		set_variable = {
			which = blackjack_deck_6
			value = 2
		}

		set_variable = {
			which = blackjack_deck_7
			value = 2
		}

		set_variable = {
			which = blackjack_deck_8
			value = 3
		}

		set_variable = {
			which = blackjack_deck_9
			value = 3
		}

		set_variable = {
			which = blackjack_deck_10
			value = 3
		}

		set_variable = {
			which = blackjack_deck_11
			value = 3
		}

		set_variable = {
			which = blackjack_deck_12
			value = 4
		}

		set_variable = {
			which = blackjack_deck_13
			value = 4
		}

		set_variable = {
			which = blackjack_deck_14
			value = 4
		}

		set_variable = {
			which = blackjack_deck_15
			value = 4
		}

		set_variable = {
			which = blackjack_deck_16
			value = 5
		}

		set_variable = {
			which = blackjack_deck_17
			value = 5
		}

		set_variable = {
			which = blackjack_deck_18
			value = 5
		}

		set_variable = {
			which = blackjack_deck_19
			value = 5
		}

		set_variable = {
			which = blackjack_deck_20
			value = 6
		}

		set_variable = {
			which = blackjack_deck_21
			value = 6
		}

		set_variable = {
			which = blackjack_deck_22
			value = 6
		}

		set_variable = {
			which = blackjack_deck_23
			value = 6
		}

		set_variable = {
			which = blackjack_deck_24
			value = 7
		}

		set_variable = {
			which = blackjack_deck_25
			value = 7
		}

		set_variable = {
			which = blackjack_deck_26
			value = 7
		}

		set_variable = {
			which = blackjack_deck_27
			value = 7
		}

		set_variable = {
			which = blackjack_deck_28
			value = 8
		}

		set_variable = {
			which = blackjack_deck_29
			value = 8
		}

		set_variable = {
			which = blackjack_deck_30
			value = 8
		}

		set_variable = {
			which = blackjack_deck_31
			value = 8
		}

		set_variable = {
			which = blackjack_deck_32
			value = 9
		}

		set_variable = {
			which = blackjack_deck_33
			value = 9
		}

		set_variable = {
			which = blackjack_deck_34
			value = 9
		}

		set_variable = {
			which = blackjack_deck_35
			value = 9
		}

		set_variable = {
			which = blackjack_deck_36
			value = 10
		}

		set_variable = {
			which = blackjack_deck_37
			value = 10
		}

		set_variable = {
			which = blackjack_deck_38
			value = 10
		}

		set_variable = {
			which = blackjack_deck_39
			value = 10
		}

		set_variable = {
			which = blackjack_deck_40
			value = 11
		}

		set_variable = {
			which = blackjack_deck_41
			value = 11
		}

		set_variable = {
			which = blackjack_deck_42
			value = 11
		}

		set_variable = {
			which = blackjack_deck_43
			value = 11
		}

		set_variable = {
			which = blackjack_deck_44
			value = 12
		}

		set_variable = {
			which = blackjack_deck_45
			value = 12
		}

		set_variable = {
			which = blackjack_deck_46
			value = 12
		}

		set_variable = {
			which = blackjack_deck_47
			value = 12
		}

		set_variable = {
			which = blackjack_deck_48
			value = 13
		}

		set_variable = {
			which = blackjack_deck_49
			value = 13
		}

		set_variable = {
			which = blackjack_deck_50
			value = 13
		}

		set_variable = {
			which = blackjack_deck_51
			value = 13
		}

		set_variable = {
			which = blackjack_deck_52
			value = 14
		}

		set_variable = {
			which = blackjack_deck_53
			value = 14
		}

		set_variable = {
			which = blackjack_deck_54
			value = 14
		}

		set_variable = {
			which = blackjack_deck_55
			value = 14
		}

		set_variable = {
			which = blackjack_deck_56
			value = 15
		}

		set_variable = {
			which = blackjack_deck_57
			value = 15
		}

		set_variable = {
			which = blackjack_deck_58
			value = 15
		}

		set_variable = {
			which = blackjack_deck_59
			value = 15
		}

		set_variable = {
			which = blackjack_deck_60
			value = 16
		}

		set_variable = {
			which = blackjack_deck_61
			value = 16
		}

		set_variable = {
			which = blackjack_deck_62
			value = 16
		}

		set_variable = {
			which = blackjack_deck_63
			value = 16
		}

		set_variable = {
			which = blackjack_deck_64
			value = 17
		}

		set_variable = {
			which = blackjack_deck_65
			value = 17
		}

		set_variable = {
			which = blackjack_deck_66
			value = 17
		}

		set_variable = {
			which = blackjack_deck_67
			value = 17
		}

		set_variable = {
			which = blackjack_deck_68
			value = 18
		}

		set_variable = {
			which = blackjack_deck_69
			value = 18
		}

		set_variable = {
			which = blackjack_deck_70
			value = 18
		}

		set_variable = {
			which = blackjack_deck_71
			value = 18
		}

		set_variable = {
			which = blackjack_deck_72
			value = 19
		}

		set_variable = {
			which = blackjack_deck_73
			value = 19
		}

		set_variable = {
			which = blackjack_deck_74
			value = 19
		}

		set_variable = {
			which = blackjack_deck_75
			value = 19
		}

		set_variable = {
			which = blackjack_deck_76
			value = 20
		}

		set_variable = {
			which = blackjack_deck_77
			value = 20
		}

		set_variable = {
			which = blackjack_deck_78
			value = 20
		}

		set_variable = {
			which = blackjack_deck_79
			value = 20
		}

		set_variable = {
			which = blackjack_deck_80
			value = 21
		}

		set_variable = {
			which = blackjack_deck_81
			value = 21
		}

		set_variable = {
			which = blackjack_deck_82
			value = 21
		}

		set_variable = {
			which = blackjack_deck_83
			value = 21
		}

		set_variable = {
			which = blackjack_deck_84
			value = 22
		}

		set_variable = {
			which = blackjack_deck_85
			value = 22
		}

		set_variable = {
			which = blackjack_deck_86
			value = 22
		}

		set_variable = {
			which = blackjack_deck_87
			value = 22
		}

		set_variable = {
			which = blackjack_deck_88
			value = 23
		}

		set_variable = {
			which = blackjack_deck_89
			value = 23
		}

		set_variable = {
			which = blackjack_deck_90
			value = 23
		}

		set_variable = {
			which = blackjack_deck_91
			value = 23
		}

		set_variable = {
			which = blackjack_deck_92
			value = 24
		}

		set_variable = {
			which = blackjack_deck_93
			value = 24
		}

		set_variable = {
			which = blackjack_deck_94
			value = 24
		}

		set_variable = {
			which = blackjack_deck_95
			value = 24
		}

		set_variable = {
			which = blackjack_deck_96
			value = 25
		}

		set_variable = {
			which = blackjack_deck_97
			value = 25
		}

		set_variable = {
			which = blackjack_deck_98
			value = 25
		}

		set_variable = {
			which = blackjack_deck_99
			value = 25
		}

		set_variable = {
			which = blackjack_deck_100
			value = 26
		}

		set_variable = {
			which = blackjack_deck_101
			value = 26
		}

		set_variable = {
			which = blackjack_deck_102
			value = 26
		}

		set_variable = {
			which = blackjack_deck_103
			value = 26
		}

		set_variable = {
			which = blackjack_deck_104
			value = 27
		}

		set_variable = {
			which = blackjack_deck_105
			value = 27
		}

		set_variable = {
			which = blackjack_deck_106
			value = 27
		}

		set_variable = {
			which = blackjack_deck_107
			value = 27
		}

		set_variable = {
			which = blackjack_deck_108
			value = 28
		}

		set_variable = {
			which = blackjack_deck_109
			value = 28
		}

		set_variable = {
			which = blackjack_deck_110
			value = 28
		}

		set_variable = {
			which = blackjack_deck_111
			value = 28
		}

		set_variable = {
			which = blackjack_deck_112
			value = 29
		}

		set_variable = {
			which = blackjack_deck_113
			value = 29
		}

		set_variable = {
			which = blackjack_deck_114
			value = 29
		}

		set_variable = {
			which = blackjack_deck_115
			value = 29
		}

		set_variable = {
			which = blackjack_deck_116
			value = 30
		}

		set_variable = {
			which = blackjack_deck_117
			value = 30
		}

		set_variable = {
			which = blackjack_deck_118
			value = 30
		}

		set_variable = {
			which = blackjack_deck_119
			value = 30
		}

		set_variable = {
			which = blackjack_deck_120
			value = 31
		}

		set_variable = {
			which = blackjack_deck_121
			value = 31
		}

		set_variable = {
			which = blackjack_deck_122
			value = 31
		}

		set_variable = {
			which = blackjack_deck_123
			value = 31
		}

		set_variable = {
			which = blackjack_deck_124
			value = 32
		}

		set_variable = {
			which = blackjack_deck_125
			value = 32
		}

		set_variable = {
			which = blackjack_deck_126
			value = 32
		}

		set_variable = {
			which = blackjack_deck_127
			value = 32
		}

		set_variable = {
			which = blackjack_deck_128
			value = 33
		}

		set_variable = {
			which = blackjack_deck_129
			value = 33
		}

		set_variable = {
			which = blackjack_deck_130
			value = 33
		}

		set_variable = {
			which = blackjack_deck_131
			value = 33
		}

		set_variable = {
			which = blackjack_deck_132
			value = 34
		}

		set_variable = {
			which = blackjack_deck_133
			value = 34
		}

		set_variable = {
			which = blackjack_deck_134
			value = 34
		}

		set_variable = {
			which = blackjack_deck_135
			value = 34
		}

		set_variable = {
			which = blackjack_deck_136
			value = 35
		}

		set_variable = {
			which = blackjack_deck_137
			value = 35
		}

		set_variable = {
			which = blackjack_deck_138
			value = 35
		}

		set_variable = {
			which = blackjack_deck_139
			value = 35
		}

		set_variable = {
			which = blackjack_deck_140
			value = 36
		}

		set_variable = {
			which = blackjack_deck_141
			value = 36
		}

		set_variable = {
			which = blackjack_deck_142
			value = 36
		}

		set_variable = {
			which = blackjack_deck_143
			value = 36
		}

		set_variable = {
			which = blackjack_deck_144
			value = 37
		}

		set_variable = {
			which = blackjack_deck_145
			value = 37
		}

		set_variable = {
			which = blackjack_deck_146
			value = 37
		}

		set_variable = {
			which = blackjack_deck_147
			value = 37
		}

		set_variable = {
			which = blackjack_deck_148
			value = 38
		}

		set_variable = {
			which = blackjack_deck_149
			value = 38
		}

		set_variable = {
			which = blackjack_deck_150
			value = 38
		}

		set_variable = {
			which = blackjack_deck_151
			value = 38
		}

		set_variable = {
			which = blackjack_deck_152
			value = 39
		}

		set_variable = {
			which = blackjack_deck_153
			value = 39
		}

		set_variable = {
			which = blackjack_deck_154
			value = 39
		}

		set_variable = {
			which = blackjack_deck_155
			value = 39
		}

		set_variable = {
			which = blackjack_deck_156
			value = 40
		}

		set_variable = {
			which = blackjack_deck_157
			value = 40
		}

		set_variable = {
			which = blackjack_deck_158
			value = 40
		}

		set_variable = {
			which = blackjack_deck_159
			value = 40
		}

		set_variable = {
			which = blackjack_deck_160
			value = 41
		}

		set_variable = {
			which = blackjack_deck_161
			value = 41
		}

		set_variable = {
			which = blackjack_deck_162
			value = 41
		}

		set_variable = {
			which = blackjack_deck_163
			value = 41
		}

		set_variable = {
			which = blackjack_deck_164
			value = 42
		}

		set_variable = {
			which = blackjack_deck_165
			value = 42
		}

		set_variable = {
			which = blackjack_deck_166
			value = 42
		}

		set_variable = {
			which = blackjack_deck_167
			value = 42
		}

		set_variable = {
			which = blackjack_deck_168
			value = 43
		}

		set_variable = {
			which = blackjack_deck_169
			value = 43
		}

		set_variable = {
			which = blackjack_deck_170
			value = 43
		}

		set_variable = {
			which = blackjack_deck_171
			value = 43
		}

		set_variable = {
			which = blackjack_deck_172
			value = 44
		}

		set_variable = {
			which = blackjack_deck_173
			value = 44
		}

		set_variable = {
			which = blackjack_deck_174
			value = 44
		}

		set_variable = {
			which = blackjack_deck_175
			value = 44
		}

		set_variable = {
			which = blackjack_deck_176
			value = 45
		}

		set_variable = {
			which = blackjack_deck_177
			value = 45
		}

		set_variable = {
			which = blackjack_deck_178
			value = 45
		}

		set_variable = {
			which = blackjack_deck_179
			value = 45
		}

		set_variable = {
			which = blackjack_deck_180
			value = 46
		}

		set_variable = {
			which = blackjack_deck_181
			value = 46
		}

		set_variable = {
			which = blackjack_deck_182
			value = 46
		}

		set_variable = {
			which = blackjack_deck_183
			value = 46
		}

		set_variable = {
			which = blackjack_deck_184
			value = 47
		}

		set_variable = {
			which = blackjack_deck_185
			value = 47
		}

		set_variable = {
			which = blackjack_deck_186
			value = 47
		}

		set_variable = {
			which = blackjack_deck_187
			value = 47
		}

		set_variable = {
			which = blackjack_deck_188
			value = 48
		}

		set_variable = {
			which = blackjack_deck_189
			value = 48
		}

		set_variable = {
			which = blackjack_deck_190
			value = 48
		}

		set_variable = {
			which = blackjack_deck_191
			value = 48
		}

		set_variable = {
			which = blackjack_deck_192
			value = 49
		}

		set_variable = {
			which = blackjack_deck_193
			value = 49
		}

		set_variable = {
			which = blackjack_deck_194
			value = 49
		}

		set_variable = {
			which = blackjack_deck_195
			value = 49
		}

		set_variable = {
			which = blackjack_deck_196
			value = 50
		}

		set_variable = {
			which = blackjack_deck_197
			value = 50
		}

		set_variable = {
			which = blackjack_deck_198
			value = 50
		}

		set_variable = {
			which = blackjack_deck_199
			value = 50
		}

		set_variable = {
			which = blackjack_deck_200
			value = 51
		}

		set_variable = {
			which = blackjack_deck_201
			value = 51
		}

		set_variable = {
			which = blackjack_deck_202
			value = 51
		}

		set_variable = {
			which = blackjack_deck_203
			value = 51
		}

		set_variable = {
			which = blackjack_deck_204
			value = 52
		}

		set_variable = {
			which = blackjack_deck_205
			value = 52
		}

		set_variable = {
			which = blackjack_deck_206
			value = 52
		}

		set_variable = {
			which = blackjack_deck_207
			value = 52
		}
    }
}

# Triggers on action for shuffling the deck
blackjack_shuffle_deck_wrapper = {
    # full effect in separate file for brevity
    # on_new_monarch on_action is where it is called to reset randomness

    set_global_flag = blackjack_shuffling_deck
    random_country = {
        limit = {
            AND = {
                ai = yes
                NOT = { total_development = 70 }
            }
        }
        define_ruler = {
            dynasty = original_dynasty
        }
    }
}